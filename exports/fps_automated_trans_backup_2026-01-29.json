{"objects":[{"jobObject":{"JobType":".TransformationJob","id":4417452,"revision":36,"created":1743300747667,"timestamp":1743300747667,"components":{"4418731":{"id":4418731,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":638,"y":242,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[4418747],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SQL 0"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"/* Base records table */\nwith base_records as (\n    select\n        par.runtime_dt_utc\n        ,par.inserted_dt_utc\n        ,par.mapped_manufacturing_location\n        ,par.mapped_distribution_location\n        ,par.sku\n        ,par.filter_type\n        ,par.merv_rating\n        ,par.sku_without_merv_rating\n        ,par.days_of_inventory_remaining\n        ,par.ranking\n        ,par.production_goal_within_max_lines\n        ,par.production_goal_outside_max_lines\n        ,ps.staffing_available\n        ,lch.count_of_lines\n        ,fpp.filters_per_pallet\n        ,par.production_capacity\n        ,par.auto_tooling_sets\n    from ${stg2_schema}.ps_automated_ranking par\n        join ${stg2_schema}.ps_staffing_by_dt ps on ps.dt = par.inserted_dt_utc::date\n            and par.mapped_manufacturing_location = ps.mapped_manufacturing_location\n            and ps.grouped_line_type = 'Automated'\n        join ${stg2_schema}.ps_line_count_history lch on lch.is_selected_dt\n            and lch.mapped_manufacturing_location = par.mapped_manufacturing_location\n            and lch.line_type = 'Automated'\n        join ${stg2_schema}.ps_filters_per_pallet_history fpp on fpp.is_selected_dt\n            and fpp.sku_without_merv_rating = par.sku_without_merv_rating\n)\n\n/* Transform from a SKU to a SKU without MERV rating basis.\n * Automated production is limited by:\n *      (1) Staffing\n *      (2) Maximum number of automated lines to run a SKU without MERV rating on\n *      (3) Tooling sets for the SKU without MERV rating\n * #1 will be considered in later CTEs.\n * #2 is considered in a prior ETL job (i.e., production_goal_within_max_lines and production_goal_outside_max_lines).\n * #3 is considered here.\n * Determine the factoring value for (1) within maximum lines and (2) outside maximum lines.\n */\n, factoring as (\n    select\n        mapped_manufacturing_location\n        ,sku_without_merv_rating\n        /* Factor production goals that are within the maximum number of lines allowed (#2 above).\n         * If the number of lines needed is less than or equal to the auto tooling sets, don't factor the production goal.\n         * If the number of lines needed is greater than the auto tooling sets, factor the production goal down.\n         */\n        ,sum(production_goal_within_max_lines)                                                          as within_lines_total\n        ,(sum(production_goal_within_max_lines)::float / production_capacity::float)::decimal(10,2)     as within_lines_production_lines\n        ,case when auto_tooling_sets >= within_lines_production_lines then 1\n            else auto_tooling_sets::float / within_lines_production_lines end                           as within_lines_factor\n        /* Identify the number of tooling sets (if any) that are still available after the within maximum number of lines production goal is satisfied */\n        ,case when auto_tooling_sets >= within_lines_production_lines\n            then auto_tooling_sets - within_lines_production_lines\n            else 0 end                                                                                  as outside_lines_tooling_sets\n        /* Factor production goals that are outside the maximum number of lines allowed (#2 above).\n         * If the number of lines needed is less than or equal to the number of remaining auto tooling sets, don't factor the production goal.\n         * If the number of lines needed is greater than the number of remaining auto tooling sets, factor the production goal down.\n         */\n        ,sum(production_goal_outside_max_lines)                                                         as outside_lines_total\n        ,(sum(production_goal_outside_max_lines)::float / production_capacity::float)::decimal(10,2)    as outside_lines_production_lines\n        ,case when outside_lines_tooling_sets >= outside_lines_production_lines then 1\n            else outside_lines_tooling_sets::float / outside_lines_production_lines end                 as outside_lines_factor\n    from base_records\n    group by 1,2\n        ,production_capacity,auto_tooling_sets\n)\n\n, automated_production as (\n    select\n        br.runtime_dt_utc\n        ,br.inserted_dt_utc\n        ,br.mapped_manufacturing_location\n        ,br.mapped_distribution_location\n        ,'Automated' as line_type\n        ,br.sku_without_merv_rating\n        ,br.staffing_available as lines_available_over_manufacturing_location_line_type\n        ,br.ranking as rank_over_manufacturing_location_line_type\n        ,br.filters_per_pallet as filters_per_pallet_over_sku_without_merv_rating\n        ,round(sum(case when br.merv_rating = 'MERV 8' then br.production_goal_within_max_lines else 0 end)::float\n            * f.within_lines_factor) as production_goal_merv_8\n        ,round(sum(case when br.merv_rating = 'MERV 11' then br.production_goal_within_max_lines else 0 end)::float\n            * f.within_lines_factor) as production_goal_merv_11\n        ,round(sum(case when br.merv_rating = 'MERV 13' then br.production_goal_within_max_lines else 0 end)::float\n            * f.within_lines_factor) as production_goal_merv_13\n        ,round(sum(case when br.merv_rating = 'MERV 8 Odor Eliminator' then br.production_goal_within_max_lines else 0 end)::float\n            * f.within_lines_factor) as production_goal_merv_8_odor_eliminator\n        ,production_goal_merv_8 + production_goal_merv_11 + production_goal_merv_13 + production_goal_merv_8_odor_eliminator as production_goal_total\n        ,(production_goal_total::float / br.production_capacity::float)::decimal(10,2) as production_lines\n        ,0::decimal(10,2)   as changeover_production_lines\n        ,case when sum(production_goal_total::float / br.production_capacity::float) over (partition by br.mapped_manufacturing_location order by br.ranking asc rows unbounded preceding) <= br.staffing_available then true\n            else false end as is_within_capacity\n        ,max(case when br.merv_rating = 'MERV 8' then br.days_of_inventory_remaining end) as current_days_of_inventory_merv_8\n        ,max(case when br.merv_rating = 'MERV 11' then br.days_of_inventory_remaining end) as current_days_of_inventory_merv_11\n        ,max(case when br.merv_rating = 'MERV 13' then br.days_of_inventory_remaining end) as current_days_of_inventory_merv_13\n        ,max(case when br.merv_rating = 'MERV 8 Odor Eliminator' then br.days_of_inventory_remaining end) as current_days_of_inventory_merv_8_odor_eliminator\n    from base_records br\n        join factoring f on f.mapped_manufacturing_location = br.mapped_manufacturing_location\n            and f.sku_without_merv_rating = br.sku_without_merv_rating\n    group by 1,2,3,4,5,6,7,8,9\n        ,br.production_capacity, f.within_lines_factor\n)\n\n-------------------------------------------\n-- Automated Production Threshold Exceeded --\n-------------------------------------------\nselect\n    br.runtime_dt_utc\n    ,br.inserted_dt_utc\n    ,br.mapped_manufacturing_location\n    ,br.mapped_distribution_location\n    ,'Automated Production Threshold Exceeded' as line_type\n    ,br.sku_without_merv_rating\n    ,null::int                  as lines_available_over_manufacturing_location_line_type\n    ,null::int                  as rank_over_manufacturing_location_line_type\n    ,br.filters_per_pallet      as filters_per_pallet_over_sku_without_merv_rating\n    ,round(sum(case when br.merv_rating = 'MERV 8' then br.production_goal_outside_max_lines else 0 end)::float\n        * f.outside_lines_factor) as production_goal_merv_8\n    ,round(sum(case when br.merv_rating = 'MERV 11' then br.production_goal_outside_max_lines else 0 end)::float\n        * f.outside_lines_factor) as production_goal_merv_11\n    ,round(sum(case when br.merv_rating = 'MERV 13' then br.production_goal_outside_max_lines else 0 end)::float\n        * f.outside_lines_factor)  as production_goal_merv_13\n    ,round(sum(case when br.merv_rating = 'MERV 8 Odor Eliminator' then br.production_goal_outside_max_lines else 0 end)::float\n        * f.outside_lines_factor)  as production_goal_merv_8_odor_eliminator\n    ,production_goal_merv_8 + production_goal_merv_11 + production_goal_merv_13 + production_goal_merv_8_odor_eliminator as production_goal_total\n    ,(production_goal_total::float / br.production_capacity::float)::decimal(10,2) as production_lines\n    ,0::decimal(10,2)                                               as changeover_production_lines\n    ,false                                                          as is_current_production_schedule\n    ,case when '${iteration_num}'::int = 2 then true else false end as is_tomorrow_production_schedule\n    ,case when '${iteration_num}'::int = 2 then false else true end as is_future_production_schedule\n    ,false                                                          as is_within_capacity\n    ,max(case when br.merv_rating = 'MERV 8' then br.days_of_inventory_remaining end) as current_days_of_inventory_merv_8\n    ,max(case when br.merv_rating = 'MERV 11' then br.days_of_inventory_remaining end) as current_days_of_inventory_merv_11\n    ,max(case when br.merv_rating = 'MERV 13' then br.days_of_inventory_remaining end) as current_days_of_inventory_merv_13\n    ,max(case when br.merv_rating = 'MERV 8 Odor Eliminator' then br.days_of_inventory_remaining end) as current_days_of_inventory_merv_8_odor_eliminator\nfrom base_records br\n    join factoring f on f.mapped_manufacturing_location = br.mapped_manufacturing_location\n        and f.sku_without_merv_rating = br.sku_without_merv_rating\nwhere f.outside_lines_factor > 0\ngroup by 1,2,3,4,5,6,7,8,9\n    ,br.production_capacity, f.outside_lines_factor\nhaving sum(br.production_goal_outside_max_lines) > 0\nunion all\n\n--------------------------\n-- Automated Production --\n--------------------------\nselect\n    ap0.runtime_dt_utc\n    ,ap0.inserted_dt_utc\n    ,ap0.mapped_manufacturing_location\n    ,ap0.mapped_distribution_location\n    ,ap0.line_type\n    ,ap0.sku_without_merv_rating\n    ,ap0.lines_available_over_manufacturing_location_line_type\n    ,ap0.rank_over_manufacturing_location_line_type\n    ,ap0.filters_per_pallet_over_sku_without_merv_rating\n    ,ap0.production_goal_merv_8\n    ,ap0.production_goal_merv_11\n    ,ap0.production_goal_merv_13\n    ,ap0.production_goal_merv_8_odor_eliminator\n    ,ap0.production_goal_total\n    ,ap0.production_lines\n    ,ap0.changeover_production_lines\n    ,false                                                          as is_current_production_schedule\n    ,case when '${iteration_num}'::int = 2 then true else false end as is_tomorrow_production_schedule\n    ,case when '${iteration_num}'::int = 2 then false else true end as is_future_production_schedule\n    ,case when ap1.is_within_capacity = 0 then false\n        when ap1.is_within_capacity = 1 then true end as is_within_capacity\n    ,ap0.current_days_of_inventory_merv_8\n    ,ap0.current_days_of_inventory_merv_11\n    ,ap0.current_days_of_inventory_merv_13\n    ,ap0.current_days_of_inventory_merv_8_odor_eliminator\nfrom automated_production ap0\n    join /* Subquery used to ensure all ranked products for a manufacturing location have the same is within capacity, despite rounding */\n        (select\n            mapped_manufacturing_location\n            ,rank_over_manufacturing_location_line_type\n            ,min(is_within_capacity::int) as is_within_capacity\n        from automated_production\n        group by 1,2) ap1 on ap1.mapped_manufacturing_location = ap0.mapped_manufacturing_location\n            and ap1.rank_over_manufacturing_location_line_type = ap0.rank_over_manufacturing_location_line_type"}}}},"visible":true}},"exportMappings":{},"activationStatus":"ENABLED"},"4418739":{"id":4418739,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":211954775,"x":874,"y":235,"width":32,"height":32,"inputConnectorIDs":[4418747],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"fact_production_schedule"}}}},"visible":true},"2":{"slot":2,"name":"Target Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"fact_production_schedule"}}}},"visible":true},"3":{"slot":3,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"inserted_dt_utc"},"2":{"slot":2,"type":"STRING","value":"inserted_dt_utc"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"mapped_manufacturing_location"},"2":{"slot":2,"type":"STRING","value":"manufacturing_location"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"mapped_distribution_location"},"2":{"slot":2,"type":"STRING","value":"distribution_location"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"line_type"},"2":{"slot":2,"type":"STRING","value":"line_type"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"lines_available_over_manufacturing_location_line_type"},"2":{"slot":2,"type":"STRING","value":"lines_available_over_manufacturing_location_line_type"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"rank_over_manufacturing_location_line_type"},"2":{"slot":2,"type":"STRING","value":"rank_over_manufacturing_location_line_type"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"sku_without_merv_rating"},"2":{"slot":2,"type":"STRING","value":"sku_without_merv_rating"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"filters_per_pallet_over_sku_without_merv_rating"},"2":{"slot":2,"type":"STRING","value":"filters_per_pallet_over_sku_without_merv_rating"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"production_goal_merv_8"},"2":{"slot":2,"type":"STRING","value":"production_goal_merv_8"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"production_goal_merv_11"},"2":{"slot":2,"type":"STRING","value":"production_goal_merv_11"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"production_goal_merv_13"},"2":{"slot":2,"type":"STRING","value":"production_goal_merv_13"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"production_goal_merv_8_odor_eliminator"},"2":{"slot":2,"type":"STRING","value":"production_goal_merv_8_odor_eliminator"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"production_goal_total"},"2":{"slot":2,"type":"STRING","value":"production_goal_total"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"production_lines"},"2":{"slot":2,"type":"STRING","value":"production_lines"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"current_days_of_inventory_merv_8"},"2":{"slot":2,"type":"STRING","value":"current_days_of_inventory_merv_8"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"current_days_of_inventory_merv_11"},"2":{"slot":2,"type":"STRING","value":"current_days_of_inventory_merv_11"}}},"17":{"slot":17,"values":{"1":{"slot":1,"type":"STRING","value":"current_days_of_inventory_merv_13"},"2":{"slot":2,"type":"STRING","value":"current_days_of_inventory_merv_13"}}},"18":{"slot":18,"values":{"1":{"slot":1,"type":"STRING","value":"current_days_of_inventory_merv_8_odor_eliminator"},"2":{"slot":2,"type":"STRING","value":"current_days_of_inventory_merv_8_odor_eliminator"}}},"19":{"slot":19,"values":{"1":{"slot":1,"type":"STRING","value":"is_current_production_schedule"},"2":{"slot":2,"type":"STRING","value":"is_current_production_schedule"}}},"20":{"slot":20,"values":{"1":{"slot":1,"type":"STRING","value":"is_future_production_schedule"},"2":{"slot":2,"type":"STRING","value":"is_future_production_schedule"}}},"21":{"slot":21,"values":{"1":{"slot":1,"type":"STRING","value":"is_within_capacity"},"2":{"slot":2,"type":"STRING","value":"is_within_capacity"}}},"22":{"slot":22,"values":{"1":{"slot":1,"type":"STRING","value":"is_tomorrow_production_schedule"},"2":{"slot":2,"type":"STRING","value":"is_tomorrow_production_schedule"}}},"23":{"slot":23,"values":{"1":{"slot":1,"type":"STRING","value":"runtime_dt_utc"},"2":{"slot":2,"type":"STRING","value":"runtime_dt_utc"}}}},"visible":true},"5":{"slot":5,"name":"Truncate","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Append"}}}},"visible":true},"6":{"slot":6,"name":"Automatic Compression","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":false},"7":{"slot":7,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${dwh_schema}"}}}},"visible":true}},"exportMappings":{},"activationStatus":"ENABLED"}},"connectors":{"4418747":{"id":4418747,"sourceID":4418731,"targetID":4418739}},"canUndo":true,"undoCommand":"Set Parameter","undoCreated":1741660434170,"canRedo":false,"redoCommand":"","redoCreated":-1,"notes":{},"noteConnectors":{},"variables":{"iteration_num":{"definition":{"name":"iteration_num","type":"DECIMAL","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":""}},"grids":{}},"info":{"id":4417452,"name":"fps_automated_trans","description":"","type":"TRANSFORMATION","tag":"dcecfdff-d886-458e-9a80-cbced119db86"},"path":["filterbuy_dw","dwh","jobs","production_schedule_v4","automated_production"]}],"version":"1.74.5","environment":"redshift"}